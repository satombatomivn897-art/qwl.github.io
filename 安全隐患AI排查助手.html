<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全隐患AI排查助手 (全能版)</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Markdown 解析器 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- [修改] 引入 xlsx-js-style 用于生成带样式的 Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .animate-scan {
            animation: scan 2s linear infinite;
        }
        
        @keyframes bounce-in {
            0% { transform: translate(-50%, 100%); opacity: 0; }
            60% { transform: translate(-50%, -10%); opacity: 1; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }

        .animate-bounce-in {
            animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* 状态标记动画 */
        @keyframes pulse-dot {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .status-analyzing {
            animation: pulse-dot 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- 图标组件 ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Upload = ({ className }) => <Icon className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>;
        const AlertTriangle = ({ className }) => <Icon className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const FileText = ({ className }) => <Icon className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>;
        const CheckCircle = ({ className }) => <Icon className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const RefreshCcw = ({ className }) => <Icon className={className}><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></Icon>;
        const Camera = ({ className }) => <Icon className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>;
        const Shield = ({ className }) => <Icon className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></Icon>;
        const AlertCircle = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const Copy = ({ className }) => <Icon className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></Icon>;
        const Settings = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>;
        const Key = ({ className }) => <Icon className={className}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></Icon>;
        const X = ({ className }) => <Icon className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
        const Server = ({ className }) => <Icon className={className}><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></Icon>;
        const RotateCcw = ({ className }) => <Icon className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const Globe = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>;
        const Download = ({ className }) => <Icon className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const Clock = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="16" y1="14" x2="12" y2="12"/></Icon>;
        const Plus = ({ className }) => <Icon className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
        const Layers = ({ className }) => <Icon className={className}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;

        // --- 主应用组件 ---
        const App = () => {
            // --- 状态管理 ---
            const [isAnalyzing, setIsAnalyzing] = useState(false); // 全局分析状态
            const [statusText, setStatusText] = useState(""); 
            const [showToast, setShowToast] = useState(false);
            
            // --- 历史记录 (数据源) ---
            // 结构: { id: number, imageBase64: {full, raw}, results: [], status: 'pending'|'analyzing'|'done'|'error', errorMsg: '', timestamp: string }
            const [history, setHistory] = useState([]);
            const [currentRecordId, setCurrentRecordId] = useState(null);

            // --- 配置系统 ---
            const PROVIDERS = {
                GEMINI: 'gemini',
                OPENAI: 'openai_compatible'
            };

            const [provider, setProvider] = useState(localStorage.getItem('si_provider') || PROVIDERS.OPENAI);
            const [apiKey, setApiKey] = useState(localStorage.getItem('si_api_key') || 'sk-2f8b40d8ec7e45daae7d4fdc9348381b');
            const [baseUrl, setBaseUrl] = useState(localStorage.getItem('si_base_url') || 'https://dashscope.aliyuncs.com/compatible-mode/v1');
            const [modelName, setModelName] = useState(localStorage.getItem('si_model_name') || 'qwen-vl-max');
            
            const [showSettings, setShowSettings] = useState(false);
            const fileInputRef = useRef(null);

            // Gemini 备用列表
            const GEMINI_CANDIDATES = [
                "gemini-1.5-flash", "gemini-1.5-flash-latest", "gemini-1.5-pro", "gemini-2.0-flash-exp"
            ];

            // --- 核心：队列处理器 ---
            // 监听 history 和 isAnalyzing，自动处理下一个待分析项
            useEffect(() => {
                if (isAnalyzing) return;

                const pendingItem = history.find(item => item.status === 'pending');
                if (pendingItem) {
                    processItem(pendingItem);
                }
            }, [history, isAnalyzing]);

            // --- 核心：单项分析逻辑 ---
            const processItem = async (item) => {
                setIsAnalyzing(true);
                setStatusText("正在分析队列...");
                
                // 更新当前项状态为 analyzing
                setHistory(prev => prev.map(h => h.id === item.id ? { ...h, status: 'analyzing' } : h));
                
                // 如果这是第一张或用户未手动选择其他图，自动显示当前正在分析的图
                if (!currentRecordId) {
                    setCurrentRecordId(item.id);
                }

                try {
                    let textResponse = "";
                    if (provider === PROVIDERS.GEMINI) {
                        textResponse = await analyzeWithGemini(item.imageBase64);
                    } else {
                        textResponse = await analyzeWithOpenAI(item.imageBase64);
                    }

                    const cleanJson = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                    let parsedResults = JSON.parse(cleanJson);
                    if (!Array.isArray(parsedResults)) throw new Error("返回格式不是数组");
                    parsedResults = parsedResults.map((res, idx) => ({...res, id: idx + 1}));
                    
                    // 更新成功状态
                    setHistory(prev => prev.map(h => h.id === item.id ? { 
                        ...h, 
                        status: 'done', 
                        results: parsedResults.length > 0 ? parsedResults : [],
                        errorMsg: parsedResults.length === 0 ? "未发现隐患" : ""
                    } : h));

                } catch (error) {
                    console.error("分析失败:", error);
                    // 更新失败状态
                    setHistory(prev => prev.map(h => h.id === item.id ? { 
                        ...h, 
                        status: 'error', 
                        errorMsg: error.message 
                    } : h));
                } finally {
                    setIsAnalyzing(false);
                    setStatusText("");
                }
            };

            // --- 处理多文件上传 (优化版 - 批量处理防止卡顿) ---
            const handleFileUpload = (event) => {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                // 限制最多50张照片
                const maxFiles = 50;
                if (files.length > maxFiles) {
                    alert(`最多只能上传 ${maxFiles} 张照片，已自动选择前 ${maxFiles} 张。`);
                }

                // 过滤过大文件，并限制数量
                const validFiles = Array.from(files)
                    .slice(0, maxFiles)
                    .filter(file => {
                        if (file.size > 10 * 1024 * 1024) {
                            console.warn(`文件 ${file.name} 过大，跳过`);
                            return false;
                        }
                        return true;
                    });

                if (validFiles.length === 0) return;

                // 使用批量处理避免频繁状态更新
                const maxConcurrent = 2; // 减少并发数进一步防止卡顿
                let index = 0;

                const processNextBatch = () => {
                    const batch = validFiles.slice(index, index + maxConcurrent);
                    index += maxConcurrent;

                    if (batch.length === 0) return;

                    const promises = batch.map(file => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                const base64Data = reader.result;
                                const rawBase64 = reader.result.split(',')[1];

                                resolve({
                                    id: Date.now() + Math.random(),
                                    imageBase64: { full: base64Data, raw: rawBase64 },
                                    results: [],
                                    status: 'pending',
                                    errorMsg: '',
                                    timestamp: new Date().toLocaleString(),
                                    fileName: file.name
                                });
                            };
                            reader.readAsDataURL(file);
                        });
                    });

                    Promise.all(promises).then(batchRecords => {
                        // 批量更新状态
                        setHistory(prev => [...batchRecords.reverse(), ...prev]);

                        // 如果当前没有选中任何记录，选中第一批的第一个
                        if (!currentRecordId) {
                            setCurrentRecordId(batchRecords[batchRecords.length - 1].id);
                        }

                        // 如果还有文件未处理，继续处理下一批
                        if (index < validFiles.length) {
                            // 使用 setTimeout 让 UI 有机会渲染
                            setTimeout(processNextBatch, 150);
                        }
                    });
                };

                // 开始处理
                processNextBatch();
            };

            const triggerFileInput = () => {
                fileInputRef.current.click();
            };

            // 保存设置
            const saveSettings = () => {
                localStorage.setItem('si_provider', provider);
                localStorage.setItem('si_api_key', apiKey);
                localStorage.setItem('si_base_url', baseUrl);
                localStorage.setItem('si_model_name', modelName);
                setShowSettings(false);
            };
            
            const applyPreset = (type) => {
                setProvider(PROVIDERS.OPENAI);
                if (type === 'qwen') {
                    setBaseUrl('https://dashscope.aliyuncs.com/compatible-mode/v1');
                    setModelName('qwen-vl-max');
                    alert('已应用【通义千问】配置。\n请填入您的阿里云 DashScope API Key。');
                } else if (type === 'deepseek') {
                    setBaseUrl('https://api.deepseek.com/v1');
                    setModelName('deepseek-chat'); 
                    alert('已应用【DeepSeek】配置。\n注意：DeepSeek API 目前主要支持文本，上传图片可能会报错。建议配合文本分析或等待官方更新多模态 API。');
                } else if (type === 'glm') {
                    setBaseUrl('https://open.bigmodel.cn/api/paas/v4');
                    setModelName('glm-4v');
                    alert('已应用【智谱GLM】配置。\n请填入您的智谱 API Key。');
                } else if (type === 'gemini') {
                    setProvider(PROVIDERS.GEMINI);
                    setModelName('auto');
                }
            };

            // --- Prompt ---
            const SYSTEM_PROMPT = `你是一位资深的EHS（环境、健康、安全）专家，熟悉中国《安全生产法》、《消防法》及各类GB国家标准。
请仔细分析这张图片中的安全隐患。
要求：
1. **真实识别**：只指出图片中确实存在的风险。无隐患返回空数组。
2. **专业引用**：必须引用具体的中国法律法规条款（如《建筑设计防火规范》GB 50016-2014 等）。
3. **输出格式**：返回纯 JSON 数组，无 Markdown。格式：[{ "id": 1, "issue": "...", "riskLevel": "High", "regulation": "...", "suggestion": "...", "cost": "预估整改费用(元)" }]`;

            // --- API Functions (接收 imageBase64 参数) ---
            const analyzeWithGemini = async (imgData) => {
                const currentKey = apiKey || 'AIzaSyCUiQia4UfLPu7xN6d4wk49Jr2fgEj92GY'; 
                let modelsToTry = modelName === 'auto' ? GEMINI_CANDIDATES : [modelName];
                let lastError = null;

                for (const model of modelsToTry) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: SYSTEM_PROMPT },
                                        { inline_data: { mime_type: "image/jpeg", data: imgData.raw } }
                                    ]
                                }]
                            })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        return data.candidates[0].content.parts[0].text;
                    } catch (err) {
                        lastError = err;
                    }
                }
                throw lastError;
            };

            const analyzeWithOpenAI = async (imgData) => {
                if (!apiKey) throw new Error("请在设置中填入 API Key");
                const messages = [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: SYSTEM_PROMPT },
                            { type: "image_url", image_url: { url: imgData.full } }
                        ]
                    }
                ];
                try {
                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelName,
                            messages: messages,
                            temperature: 0.1 
                        })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
                    if (!data.choices || data.choices.length === 0) throw new Error("API 返回了空结果");
                    return data.choices[0].message.content;
                } catch (err) {
                    if (err.message === 'Failed to fetch') {
                        throw new Error("跨域请求失败 (CORS)。大多数国产大模型API不支持从浏览器直接访问，请使用代理或 Allow CORS 插件。");
                    }
                    throw err;
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    setShowToast(true);
                    setTimeout(() => setShowToast(false), 3000);
                });
            };

            const getRiskLevelChinese = (level) => {
                const l = String(level).toLowerCase();
                if (l.includes('critical') || l.includes('重大')) return '重大隐患';
                if (l.includes('high') || l.includes('高')) return '高风险';
                if (l.includes('medium') || l.includes('中')) return '一般隐患';
                if (l.includes('low') || l.includes('低')) return '低风险';
                return level;
            };

            const getRiskColor = (level) => {
                const l = String(level).toLowerCase();
                if (l.includes('critical') || l.includes('重大')) return 'text-red-600 bg-red-50 border-red-200';
                if (l.includes('high') || l.includes('高')) return 'text-orange-600 bg-orange-50 border-orange-200';
                if (l.includes('medium') || l.includes('中')) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
                return 'text-gray-600 bg-gray-50 border-gray-200';
            };

            // --- 导出功能 (Excel 格式，已调整样式) ---
            const exportAllToExcel = () => {
                if (history.length === 0) {
                    alert("暂无记录可导出");
                    return;
                }

                const validRecords = history.filter(h => h.status === 'done' && h.results && h.results.length > 0);

                if (validRecords.length === 0) {
                    alert("没有已完成的记录可导出");
                    return;
                }

                try {
                    // 创建工作簿
                    const wb = XLSX.utils.book_new();

                    // 准备表格数据（数组格式）
                    // [修改] "成本预测" 改为 "可能需要的费用(元)"
                    const tableData = [
                        ['序号', '现场照片', '隐患描述', '风险等级', '法规依据', '整改建议', '可能需要的费用(元)']
                    ];

                    validRecords.forEach((record, recordIndex) => {
                        const imgFilename = `照片${recordIndex + 1}.jpg`;

                        record.results.forEach((item, idx) => {
                            const hazardNumber = `[${recordIndex + 1}-${idx + 1}]`; // 隐患编号放在描述前
                            const issueWithNumber = hazardNumber + ' ' + (item.issue || '');

                            if (idx === 0) {
                                tableData.push([
                                    recordIndex + 1,
                                    imgFilename,
                                    issueWithNumber,
                                    getRiskLevelChinese(item.riskLevel) || '',
                                    item.regulation || '',
                                    item.suggestion || '',
                                    item.cost || '' // [修改] 增加成本数据
                                ]);
                            } else {
                                tableData.push([
                                    null,  // 使用 null 而不是空字符串，便于合并
                                    null,
                                    issueWithNumber,
                                    getRiskLevelChinese(item.riskLevel) || '',
                                    item.regulation || '',
                                    item.suggestion || '',
                                    item.cost || '' // [修改] 增加成本数据
                                ]);
                            }
                        });
                    });

                    // 创建工作表
                    const ws = XLSX.utils.aoa_to_sheet(tableData);

                    // 设置列宽 (调整为更紧凑的宽度，以便在一屏/A4纸内显示，依赖自动换行)
                    ws['!cols'] = [
                        { wch: 6 },    // 序号
                        { wch: 15 },   // 现场照片
                        { wch: 30 },   // 隐患描述
                        { wch: 10 },   // 风险等级
                        { wch: 65 },   // 法规依据 [修改] 恢复为65
                        { wch: 65 },   // 整改建议 [修改] 恢复为65
                        { wch: 15 }    // 可能需要的费用(元) [新增]
                    ];

                    // 设置行高（因为列宽变窄了，文字会自动换行，默认给个较高的行高，Excel会自动调整）
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    ws['!rows'] = [];
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const regulationAddress = XLSX.utils.encode_cell({ r: R, c: 4 });
                        const suggestionAddress = XLSX.utils.encode_cell({ r: R, c: 5 });
                        const hasLongContent = (ws[regulationAddress] && ws[regulationAddress].v) || (ws[suggestionAddress] && ws[suggestionAddress].v);
                        // 如果有长内容，设置更高的初始行高，以适应更窄的列宽导致的换行
                        ws['!rows'].push({ hpx: hasLongContent ? 80 : 24 });
                    }

                    // 设置所有单元格格式（包括边框、填充、对齐）
                    for (let R = 0; R <= range.e.r; ++R) {
                        for (let C = 0; C <= 6; ++C) { // [修改] 循环范围扩大到第6列(成本预测)
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });

                            // 创建单元格对象（如果不存在）
                            if (!ws[cellAddress]) {
                                ws[cellAddress] = { v: '', t: 's' };
                            }

                            const isHeader = R === 0;
                            // [修改] 所有文字都启用自动换行，以满足"所有文字自动排版"的需求
                            const isWrapColumn = true; 

                            // 对齐方式：所有文字垂直居中
                            // 序号(0)、现场照片(1)、风险等级(3)水平居中，其他(隐患描述、法规、建议、成本)左对齐
                            // 成本(6)如果不长也可以居中，这里保持左对齐比较稳妥
                            let horizontalAlign = 'left';
                            if (isHeader || C === 0 || C === 1 || C === 3) {
                                horizontalAlign = 'center';
                            }

                            ws[cellAddress].s = {
                                font: {
                                    name: '微软雅黑',
                                    sz: isHeader ? 12 : 11,
                                    bold: isHeader
                                },
                                // [修改] 表头填充淡蓝色
                                fill: isHeader ? {
                                    fgColor: { rgb: 'D0E7FF' }, // 淡蓝色
                                    patternType: 'solid'
                                } : {
                                    fgColor: { rgb: 'FFFFFF' },
                                    patternType: 'solid'
                                },
                                alignment: {
                                    wrapText: true, // 全局自动换行
                                    vertical: 'center', 
                                    horizontal: horizontalAlign
                                },
                                // [修改] 所有单元格添加边框
                                border: {
                                    top: { style: 'thin', color: { rgb: "000000" } },
                                    bottom: { style: 'thin', color: { rgb: "000000" } },
                                    left: { style: 'thin', color: { rgb: "000000" } },
                                    right: { style: 'thin', color: { rgb: "000000" } }
                                }
                            };

                            if (isHeader) {
                                ws[cellAddress].s.font.color = { rgb: '000000' };
                                // 表头一般不换行，除非特别长，这里保持自动换行以防万一
                            }
                        }
                    }

                    // 合并单元格（相同照片的所有行）- 必须在设置格式之后
                    let currentRow = 1; // 数据从第1行开始（第0行是标题）
                    ws['!merges'] = ws['!merges'] || [];

                    validRecords.forEach((record) => {
                        const rowSpan = record.results.length;

                        // 合并序号列、现场照片列
                        if (rowSpan >= 1) {
                            ws['!merges'].push({
                                s: { r: currentRow, c: 0 }, // 序号列
                                e: { r: currentRow + rowSpan - 1, c: 0 }
                            });
                            ws['!merges'].push({
                                s: { r: currentRow, c: 1 }, // 现场照片列
                                e: { r: currentRow + rowSpan - 1, c: 1 }
                            });
                        }

                        currentRow += rowSpan;
                    });

                    XLSX.utils.book_append_sheet(wb, ws, "安全隐患排查报告");

                    // 导出为 xlsx 文件
                    const dateStr = new Date().toISOString().slice(0, 10);
                    XLSX.writeFile(wb, `安全隐患排查报告_${dateStr}.xlsx`);

                    alert(`成功导出 ${validRecords.length} 条记录！\n\n格式优化说明：\n1. 法规依据和整改建议列宽已恢复为65\n2. 已新增“可能需要的费用(元)”列\n3. 保持了表头淡蓝色填充和全边框样式`);

                } catch (error) {
                    console.error('导出失败:', error);
                    alert('导出失败，请重试。\n错误信息: ' + error.message);
                }
            };

            // 获取当前选中的记录
            const currentRecord = currentRecordId ? history.find(h => h.id === currentRecordId) : null;

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
                    {/* 头部导航 */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg shadow-md">
                                    <Shield className="w-6 h-6 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-600">
                                        安全隐患AI排查助手
                                    </h1>
                                    <p className="text-[10px] text-slate-400 font-medium tracking-wide uppercase hidden sm:block">Professional Edition</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setShowSettings(true)}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors border ${apiKey ? 'bg-green-50 text-green-700 border-green-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}
                                >
                                    <Server className="w-3.5 h-3.5" />
                                    {provider === PROVIDERS.GEMINI ? 'Google Gemini' : '自定义模型'}
                                </button>
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                                    <Settings className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]">
                            
                            {/* 左侧：列表与上传 (固定高度) */}
                            <div className="lg:col-span-3 flex flex-col gap-4 h-full overflow-hidden">
                                {/* 上传按钮 */}
                                <div 
                                    onClick={triggerFileInput}
                                    className="bg-white border-2 border-dashed border-indigo-200 rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 hover:border-indigo-400 transition-all group shrink-0"
                                >
                                    <div className="bg-indigo-100 p-3 rounded-full mb-3 group-hover:scale-110 transition-transform">
                                        <Plus className="w-6 h-6 text-indigo-600" />
                                    </div>
                                    <span className="font-semibold text-indigo-900">批量上传照片</span>
                                    <span className="text-xs text-indigo-400 mt-1">支持多选 / 队列分析</span>
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        onChange={handleFileUpload} 
                                        accept="image/*" 
                                        multiple 
                                        className="hidden" 
                                    />
                                </div>

                                {/* 列表区域 */}
                                <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                    <div className="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                        <h3 className="font-semibold text-sm text-slate-700 flex items-center gap-2">
                                            <Layers className="w-4 h-4" /> 识别列表
                                        </h3>
                                        <span className="text-xs bg-slate-200 px-2 py-0.5 rounded-full text-slate-600">{history.length}</span>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                        {history.length === 0 ? (
                                            <div className="text-center py-10 text-slate-400 text-xs">
                                                暂无记录<br/>请上传照片
                                            </div>
                                        ) : (
                                            history.map((item, index) => {
                                                const recordNumber = index + 1;
                                                return (
                                                <div 
                                                    key={item.id}
                                                    onClick={() => setCurrentRecordId(item.id)}
                                                    className={`flex gap-3 p-2 rounded-lg cursor-pointer transition-all border ${
                                                        currentRecordId === item.id 
                                                        ? 'bg-indigo-50 border-indigo-300 shadow-sm' 
                                                        : 'border-transparent hover:bg-slate-50 hover:border-slate-200'
                                                    }`}
                                                >
                                                    <div className="w-6 shrink-0 flex items-center justify-center">
                                                        <span className="text-xs font-bold text-slate-500">#{recordNumber}</span>
                                                    </div>
                                                    <div className="w-16 h-16 shrink-0 rounded-md overflow-hidden bg-slate-200 relative">
                                                        <img src={item.imageBase64.full} className="w-full h-full object-cover" />
                                                        {/* 状态遮罩 */}
                                                        {item.status === 'analyzing' && (
                                                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                                                                <RefreshCcw className="w-5 h-5 text-white animate-spin" />
                                                            </div>
                                                        )}
                                                        {item.status === 'error' && (
                                                            <div className="absolute inset-0 bg-red-500/50 flex items-center justify-center">
                                                                <AlertTriangle className="w-5 h-5 text-white" />
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                        <div className="text-xs font-medium text-slate-700 truncate mb-1">
                                                            {item.fileName || `照片 ${item.timestamp.split(' ')[1]}`}
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded border ${
                                                                item.status === 'done' 
                                                                    ? item.results.length > 0 ? 'bg-red-50 text-red-600 border-red-100' : 'bg-green-50 text-green-600 border-green-100'
                                                                    : item.status === 'analyzing' ? 'bg-blue-50 text-blue-600 border-blue-100'
                                                                    : 'bg-slate-100 text-slate-500 border-slate-200'
                                                            }`}>
                                                                {item.status === 'done' ? (item.results.length > 0 ? `${item.results.length} 处隐患` : '无隐患') : 
                                                                 item.status === 'analyzing' ? '分析中...' : 
                                                                 item.status === 'error' ? '失败' : '排队中'}
                                                            </span>
                                                            <span className="text-[10px] text-slate-400">{item.timestamp.split(' ')[1]}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )})
                                        )}
                                    </div>
                                    {/* 底部导出按钮 */}
                                    <div className="p-3 border-t border-slate-100 bg-slate-50">
                                        <button 
                                            onClick={exportAllToExcel}
                                            disabled={history.length === 0}
                                            className="w-full flex items-center justify-center gap-2 py-2 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
                                        >
                                            <Download className="w-4 h-4" /> 导出全部结果 (Excel)
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* 中间：大图预览 */}
                            <div className="lg:col-span-4 bg-black/90 rounded-2xl overflow-hidden flex items-center justify-center relative shadow-lg">
                                {currentRecord ? (
                                    <>
                                        <img src={currentRecord.imageBase64.full} className="max-w-full max-h-full object-contain" />
                                        {currentRecord.status === 'analyzing' && (
                                            <div className="absolute inset-0 bg-black/40 flex flex-col items-center justify-center backdrop-blur-sm">
                                                <div className="w-full h-1 bg-indigo-500/80 shadow-[0_0_20px_rgba(99,102,241,0.8)] absolute top-0 animate-scan"></div>
                                                <RefreshCcw className="w-10 h-10 text-white animate-spin mb-4" />
                                                <p className="text-white font-medium tracking-wider animate-pulse">AI 正在分析...</p>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div className="text-slate-500 flex flex-col items-center">
                                        <Camera className="w-12 h-12 mb-2 opacity-50" />
                                        <p className="text-sm">请选择或上传照片</p>
                                    </div>
                                )}
                            </div>

                            {/* 右侧：结果详情 */}
                            <div className="lg:col-span-5 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h2 className="font-semibold flex items-center gap-2 text-slate-800">
                                        <FileText className="w-5 h-5 text-green-600" />
                                        分析详情
                                    </h2>
                                    {currentRecord?.status === 'done' && (
                                        <button 
                                            onClick={() => copyToClipboard(JSON.stringify(currentRecord.results, null, 2))}
                                            className="text-xs text-slate-500 hover:text-indigo-600 flex items-center gap-1"
                                        >
                                            <Copy className="w-3 h-3" /> 复制 JSON
                                        </button>
                                    )}
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-slate-50/30">
                                    {!currentRecord ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                            <FileText className="w-10 h-10 mb-2 opacity-20" />
                                            <p className="text-sm">无选中内容</p>
                                        </div>
                                    ) : currentRecord.status === 'analyzing' || currentRecord.status === 'pending' ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                            <div className="status-analyzing w-3 h-3 bg-blue-500 rounded-full mb-4"></div>
                                            <p className="text-sm text-slate-500">正在生成排查报告...</p>
                                        </div>
                                    ) : currentRecord.status === 'error' ? (
                                        <div className="h-full flex flex-col items-center justify-center text-red-400 p-8 text-center">
                                            <AlertTriangle className="w-10 h-10 mb-2" />
                                            <h3 className="font-bold text-slate-700">分析中断</h3>
                                            <p className="text-xs mt-2 opacity-80 bg-red-50 p-3 rounded">{currentRecord.errorMsg}</p>
                                        </div>
                                    ) : currentRecord.results.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-green-600">
                                            <CheckCircle className="w-12 h-12 mb-2" />
                                            <p className="font-medium">未发现明显安全隐患</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {currentRecord.results.map((item, index) => (
                                                <div key={index} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                                    <div className="p-3 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex items-start gap-3">
                                                        <div className="w-6 h-6 rounded bg-slate-800 text-white flex items-center justify-center text-xs font-bold mt-0.5">{index + 1}</div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between items-start">
                                                                <h3 className="font-bold text-slate-800 text-sm">{item.issue}</h3>
                                                                <span className={`text-[10px] px-2 py-0.5 rounded border font-medium ${getRiskColor(item.riskLevel)}`}>{getRiskLevelChinese(item.riskLevel)}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="p-3 space-y-2 text-xs">
                                                        <div className="grid grid-cols-[60px_1fr] gap-2">
                                                            <span className="text-slate-500 font-medium">法规</span>
                                                            <span className="text-slate-700 bg-slate-50 p-1 rounded font-mono">{item.regulation}</span>
                                                        </div>
                                                        <div className="grid grid-cols-[60px_1fr] gap-2">
                                                            <span className="text-slate-500 font-medium">建议</span>
                                                            <span className="text-slate-700 whitespace-pre-wrap">{item.suggestion}</span>
                                                        </div>
                                                        <div className="grid grid-cols-[60px_1fr] gap-2">
                                                            <span className="text-slate-500 font-medium">费用</span>
                                                            <span className="text-indigo-600 font-bold">{item.cost}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* 设置弹窗 */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-lg flex items-center gap-2">
                                        <Settings className="w-5 h-5 text-slate-500" /> 
                                        模型与接口设置
                                    </h3>
                                    <button onClick={() => setShowSettings(false)}><X className="w-5 h-5 text-slate-400" /></button>
                                </div>
                                
                                <div className="p-6 space-y-6 overflow-y-auto">
                                    {/* API 提供商选择 */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">API 提供商 (Provider)</label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={() => applyPreset('gemini')}
                                                className={`p-3 rounded-xl border text-left transition-all ${provider === PROVIDERS.GEMINI ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' : 'border-slate-200 hover:border-slate-300'}`}
                                            >
                                                <div className="font-bold text-sm text-slate-800">Google Gemini</div>
                                                <div className="text-xs text-slate-500 mt-1">免费，需科学上网</div>
                                            </button>
                                            <button 
                                                onClick={() => setProvider(PROVIDERS.OPENAI)}
                                                className={`p-3 rounded-xl border text-left transition-all ${provider === PROVIDERS.OPENAI ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' : 'border-slate-200 hover:border-slate-300'}`}
                                            >
                                                <div className="font-bold text-sm text-slate-800">自定义 / 国产模型</div>
                                                <div className="text-xs text-slate-500 mt-1">支持通义、智谱等</div>
                                            </button>
                                        </div>
                                    </div>

                                    {provider === PROVIDERS.GEMINI && (
                                        <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">Gemini API Key</label>
                                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AIza..." className="w-full p-2.5 border rounded-lg font-mono text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">模型名称</label>
                                                <input type="text" value={modelName} onChange={(e) => setModelName(e.target.value)} placeholder="auto" className="w-full p-2.5 border rounded-lg font-mono text-sm" />
                                            </div>
                                        </div>
                                    )}

                                    {provider === PROVIDERS.OPENAI && (
                                        <div className="space-y-4 animate-in fade-in slide-in-from-top-2 border-t border-slate-100 pt-4">
                                            
                                            {/* 快速配置按钮 */}
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">快速应用国产模型配置</label>
                                                <div className="flex flex-wrap gap-2">
                                                    <button onClick={() => applyPreset('qwen')} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 border border-slate-200">
                                                        🇨🇳 阿里云通义千问 (推荐)
                                                    </button>
                                                    <button onClick={() => applyPreset('glm')} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 border border-slate-200">
                                                        🇨🇳 智谱 GLM-4V
                                                    </button>
                                                    <button onClick={() => applyPreset('deepseek')} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 border border-slate-200">
                                                        🤖 DeepSeek (仅文本)
                                                    </button>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">API Base URL</label>
                                                <input type="text" value={baseUrl} onChange={(e) => setBaseUrl(e.target.value)} placeholder="https://..." className="w-full p-2.5 border rounded-lg font-mono text-sm" />
                                                <p className="text-xs text-slate-400 mt-1">例如: https://dashscope.aliyuncs.com/compatible-mode/v1</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">API Key</label>
                                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="sk-..." className="w-full p-2.5 border rounded-lg font-mono text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">模型名称 (Model ID)</label>
                                                <input type="text" value={modelName} onChange={(e) => setModelName(e.target.value)} placeholder="qwen-vl-max" className="w-full p-2.5 border rounded-lg font-mono text-sm" />
                                            </div>

                                            <div className="bg-orange-50 p-3 rounded text-xs text-orange-800 border border-orange-100">
                                                <strong>⚠️ 关于 CORS 跨域问题：</strong><br/>
                                                大多数国产大模型 API 不支持从浏览器直接调用。如果遇到“Failed to fetch”或跨域错误，您需要：<br/>
                                                1. 使用支持 CORS 的代理服务。<br/>
                                                2. 或者在浏览器安装 "Allow CORS" 插件进行临时调试。<br/>
                                                3. 通义千问等部分模型在某些网络环境下可能支持直连。
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t border-slate-100 bg-slate-50 text-right">
                                    <button onClick={saveSettings} className="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors shadow-sm">
                                        保存并使用
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showToast && (
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm animate-bounce-in z-50">
                            已复制到剪贴板
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>